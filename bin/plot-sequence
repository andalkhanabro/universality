#!/usr/bin/env python

"""a plotting script that makes a sequence of KDEs to show how constraints change for a 1D distribution with more events or different weights
"""
__author__ = "Reed Essick (reed.essick@gmail.com)"

#-------------------------------------------------

import os
import numpy as np

from argparse improt ArgumentParser

### non-standard libraries
from universality import utils
from universality import plot

#-------------------------------------------------

parser = ArgumentParser(description=__doc__)

parser.add_argument('column', type=str)
parser.add_argument('--multiplier', type=float, defualt=1.)
parser.add_argument('--bandwidth', default=utils.DEFAULT_BANDWIDTH, type=float)
parser.add_argument('--logcolumn', default=False, action='store_true')
parser.add_argument('--range', nargs=2, type=float)

parser.add_argument('-s', '--samples', nargs=2, type=str, default=[], action='append')
parser.add_argument('-m', '--max-num-samples', nargs=2, default=[], type=str, action='append')
parser.add_argument('--weight-column', nargs=2, type=str, default=[], action='append')
parser.add_argument('--weight-column-is-log', nargs=2, type=str, default=[], action='append')

parser.add_argument('--prune', default=False, action='store_true')

parser.add_argument('-n', '--num-points', default=plot.DEFAULT_NUM_POINTS, type=int)

parser.add_argument('-v', '--verbose', default=False, action='store_true')

parser.add_argument('-o', '--output-dir', default='.', type=str)
parser.add_argument('-t', '--tag', default='', type=str)
parser.add_argument('--figtype', default=[], type=str, action='append')
parser.add_argument('--dpi', default=plot.DEFAULT_DPI, type=float)

args = parser.parse_args()

### finish parsing
if not os.path.exists(args.output_dir):
    os.makedirs(args.output_dir)

if args.tag:
    args.tag = "_"+args.tag

if not args.figtype:
    args.figtype = plot.DEFAULT_FIGTYPE

names = [label for label, path in args.samples]

max_num_samples = dict((label, np.infty) for label in names)
for label, num in args.max_num_samples:
    assert label in names, 'specifying --max-num-sample for unknown sample set: '+label
    max_num_samples[label] = int(num)

weight_columns = dict((label, ([], [])) for label in names)
for label, column in args.weight_column:
    assert label in names, 'specifying --weight-column for unknown sample set: '+label
    weight_columns[label][0].append(column)
for label, column in args.weight_column_is_log:
    assert label in names, 'specifying --weight-column-is-log for unknown sample set: '+label
    weight_columns[label][1].append(column)

logcolumns = [args.column] if args.logcolumn else []

#-------------------------------------------------

fig = plot.figure()
ax = fig.gca()

for label, path in args.samples:
    if args.verbose:
        print('reading in samples for %s from: %s'%(label, path))
    data, _ = utils.load(path, [args.column], logcolumns=logcolumns, max_num_samples=max_num_samples[label])

    if weight_columns[label][0]:
        if args.verbose:
            print('reading in non-trivial weights from: '+path)
        weights = utils.load_weights(path, weight_columns[label][0], logweightcolumns=weight_columns[label][1], max_num_samples=max_num_samples[label])

    else:
        N = len(data)
        weights = np.ones(N, dtype='float')/N

    if args.range:
        m, M = args.range
    else:
        m, M = np.min(data), np.max(data)

    if args.prune:### throw away data that's outside the bounds
        data, weights = utils.prune(data, [(m, M)], weights=weights)

    data = data[:,0]
    samples = np.linspace(m, M, args.num_points)

    raise NotImplementedError('''\
generate KDE
make a violin plot of KDEs with each set of samples as one value on the x-axis, and change xticklabels to be the sample labels
''')

### save
plot.save('plot-sequence%s'%args.tag, fig, figtypes=args.figtype, directory=args.output_dir, verbose=args.verbose, dpi=args.dpi)
plot.close(fig)

#!/usr/bin/env python

__usage__ = "hdf52csv [--options] samples.hdf5 [output.csv]"
__doc__ = "a simple conversion script to change file formats"
__author__ = "reed.essick@ligo.org"

#-------------------------------------------------

import h5py

from optparse import OptionParser

#-------------------------------------------------

parser = OptionParser(usage=__usage__, description=__doc__)

parser.add_option('-v', '--verbose', default=False, action='store_true')

opts, args = parser.parse_args()
N = len(args)
assert 0<N<3, 'please supply either 1 or 2 input arguments\n%s'%__usage__
inpath = args[0]
outpath = args[1] if N>1 else inpath.replace('hdf5','csv')

#-------------------------------------------------

if opts.verbose:
    print('reading posterior samples from: '+inpath)
with h5py.File(inpath, 'r') as file_obj:
    samples = file_obj['lalinference'][file_obj['lalinference'].keys()[0]]['posterior_samples'][...]

if opts.verbose:
    print('writing samples to: '+outpath)
tmp = ','.join('%.6f' for _ in samples.dtype.names)
with open(outpath, 'w') as file_obj:
    print >> file_obj, ','.join(samples.dtype.names)
    for sample in samples:
        print >> file_obj, tmp%tuple(sample)
